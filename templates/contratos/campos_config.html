{% extends "base.html" %}
{% block title %}Configurar Campos{% endblock %}
{% block page_title %}Configurar Campos{% endblock %}
{% block active_modelos %}active{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header py-3 px-4">
    <i class="bi bi-sliders me-2 text-muted"></i>
    Campos do modelo: <strong>{{ modelo.nome }}</strong>
  </div>
  <div class="card-body px-4 py-4">
    {% if campos %}
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="ordem_lista" id="ordemLista" value="">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 48px;"></th>
              <th>Placeholder</th>
              <th>Label</th>
              <th>Tipo</th>
              <th>Obrigatorio</th>
              <th>Opcoes</th>
            </tr>
          </thead>
          <tbody id="camposSortBody">
            {% for campo in campos %}
            <tr data-campo-id="{{ campo.id }}" draggable="true">
              <td class="text-muted">
                <i class="bi bi-grip-vertical"></i>
              </td>
              <td class="font-monospace small">{{ campo.placeholder }}</td>
              <td>
                <input type="text" name="label_{{ campo.id }}" value="{{ campo.label }}" class="form-control form-control-sm" required>
                <input type="text" name="ajuda_{{ campo.id }}" value="{{ campo.ajuda }}" class="form-control form-control-sm mt-2" placeholder="Ajuda (opcional)">
                <input type="text" name="mascara_{{ campo.id }}" value="{{ campo.mascara }}" class="form-control form-control-sm mt-2" placeholder="Mascara (opcional)">
              </td>
              <td>
                <select name="tipo_{{ campo.id }}" class="form-select form-select-sm">
                  {% for value, label in tipos %}
                  <option value="{{ value }}" {% if campo.tipo == value %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td class="text-center">
                <input type="checkbox" name="obrigatorio_{{ campo.id }}" {% if campo.obrigatorio %}checked{% endif %}>
              </td>
              <td>
                <input type="text" name="opcoes_{{ campo.id }}" value="{% if campo.opcoes %}{{ campo.opcoes|join:", " }}{% endif %}" class="form-control form-control-sm" placeholder="Separar por virgula">
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>Salvar
        </button>
        <a href="/modelos/" class="btn btn-outline-secondary">Voltar</a>
      </div>
    </form>
    {% else %}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-info-circle fs-2 d-block mb-2"></i>
      Nenhum placeholder detectado neste modelo.
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    var body = document.getElementById("camposSortBody");
    var ordemInput = document.getElementById("ordemLista");
    if (!body || !ordemInput) {
      return;
    }

    var draggingRow = null;

    function updateOrderInput() {
      var ids = Array.prototype.map.call(body.querySelectorAll("tr[data-campo-id]"), function (row) {
        return row.getAttribute("data-campo-id");
      });
      ordemInput.value = ids.join(",");
    }

    body.addEventListener("dragstart", function (event) {
      var row = event.target.closest("tr");
      if (!row) {
        return;
      }
      draggingRow = row;
      event.dataTransfer.effectAllowed = "move";
      event.dataTransfer.setData("text/plain", "drag");
      row.classList.add("table-active");
    });

    body.addEventListener("dragend", function () {
      if (draggingRow) {
        draggingRow.classList.remove("table-active");
      }
      draggingRow = null;
      updateOrderInput();
    });

    body.addEventListener("dragover", function (event) {
      event.preventDefault();
      var row = event.target.closest("tr");
      if (!draggingRow || !row || row === draggingRow) {
        return;
      }
      var rect = row.getBoundingClientRect();
      var shouldInsertAfter = event.clientY > rect.top + rect.height / 2;
      var referenceNode = shouldInsertAfter ? row.nextSibling : row;
      body.insertBefore(draggingRow, referenceNode);
    });

    var form = body.closest("form");
    if (form) {
      form.addEventListener("submit", updateOrderInput);
    }

    updateOrderInput();
  })();
</script>
{% endblock %}
